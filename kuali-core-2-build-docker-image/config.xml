<?xml version='1.0' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Build the docker image for cor-main</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>-1</daysToKeep>
        <numToKeep>5</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.BooleanParameterDefinition>
          <name>VERBOSE</name>
          <description>Log output will be verbose</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DRYRUN</name>
          <description>Gather all the parameters for the build and print out the final docker command, but DO NOT run that command.</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>GIT_PULL</name>
          <description>The Dockerfile includes instructions to pull source code from git.
This step can be skipped by unchecking this box if the content of the build workspace contains the right source code from the last build attempt.

</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <org.biouno.unochoice.DynamicReferenceParameter plugin="uno-choice@1.5.2">
          <name>GIT_REPO_URL</name>
          <description>The git repository from which the build will pull source code.
&lt;br&gt;
&lt;br&gt;</description>
          <randomName>choice-parameter-7427131157409288</randomName>
          <visibleItemCount>1</visibleItemCount>
          <script class="org.biouno.unochoice.model.GroovyScript">
            <secureScript plugin="script-security@1.24">
              <script>if(!GIT_PULL) {
  return &quot;&lt;input type=&apos;text&apos; readonly=true name=&apos;value&apos; style=&apos;width:400px; font-family:monospace;&apos; disabled=true&gt;&quot;
}

def url = &quot;git@github.com:bu-ist/kuali-core-main.git&quot;
return &quot;&lt;input type=&apos;text&apos; readonly=true disabled=true name=&apos;value&apos; style=&apos;width:400px; font-family:monospace;&apos; value=&apos;&quot; +  url + &quot;&apos;&gt;&quot;</script>
              <sandbox>false</sandbox>
            </secureScript>
            <secureFallbackScript plugin="script-security@1.24">
              <script>return &quot;&lt;input type=&apos;text&apos; name=&apos;value&apos; value=&apos;error&apos; style=&apos;width:400px;&apos; disabled=true&gt;&quot;</script>
              <sandbox>false</sandbox>
            </secureFallbackScript>
          </script>
          <projectName>kuali-core-2-build-docker-image</projectName>
          <parameters class="linked-hash-map"/>
          <referencedParameters>GIT_PULL</referencedParameters>
          <choiceType>ET_FORMATTED_HTML</choiceType>
          <omitValueField>false</omitValueField>
        </org.biouno.unochoice.DynamicReferenceParameter>
        <org.biouno.unochoice.CascadeChoiceParameter plugin="uno-choice@1.5.2">
          <name>GIT_REF_TYPE</name>
          <description>&lt;br&gt;
Select how you would like to determine your git commit ID
&lt;br&gt;
&lt;br&gt;</description>
          <randomName>choice-parameter-7685695751922832</randomName>
          <visibleItemCount>1</visibleItemCount>
          <script class="org.biouno.unochoice.model.GroovyScript">
            <secureScript plugin="script-security@1.24">
              <script>if(!GIT_PULL) {
   def list = [&apos;N/A:selected&apos;]
}
else {
   def list = [&apos;Branch:selected&apos;, &apos;Tag&apos;, &apos;Commit ID&apos;]
}</script>
              <sandbox>false</sandbox>
            </secureScript>
            <secureFallbackScript plugin="script-security@1.24">
              <script>def list = [error]</script>
              <sandbox>false</sandbox>
            </secureFallbackScript>
          </script>
          <projectName>kuali-core-2-build-docker-image</projectName>
          <parameters class="linked-hash-map"/>
          <referencedParameters>GIT_PULL</referencedParameters>
          <choiceType>PT_RADIO</choiceType>
          <filterable>false</filterable>
        </org.biouno.unochoice.CascadeChoiceParameter>
        <org.biouno.unochoice.DynamicReferenceParameter plugin="uno-choice@1.5.2">
          <name>GIT_REF</name>
          <description></description>
          <randomName>choice-parameter-7674629742670960</randomName>
          <visibleItemCount>1</visibleItemCount>
          <script class="org.biouno.unochoice.model.GroovyScript">
            <secureScript plugin="script-security@1.24">
              <script>if(!GIT_PULL) {
  return &quot;&lt;input type=&apos;text&apos; readonly=true name=&apos;value&apos; style=&apos;width:400px; font-family:monospace;&apos; disabled=true&gt;&quot;
}

// Instantiate a string builder to build a dropdown box populated with all the branches in the target git repo
def sb = new StringBuilder(&quot;&lt;select name=&apos;value&apos; style=&apos;width:400px; font-family:monospace;&apos;&gt;&quot;)
def defaultValue = null
def process = null
def cmd = &quot;ssh-add /var/lib/jenkins/.ssh/bu_github_id_core_rsa &gt; /dev/null 2&gt;&amp;1; &quot;

// Create a command to that passed to ssh-agent to run with sh that will acquire the list of branches in the target git repo
if (&quot;branch&quot;.equalsIgnoreCase(GIT_REF_TYPE)) {
   defaultValue = &apos;coi-ui-1802.0001&apos;
   cmd = cmd +
      &quot;git -c core.askpass=true ls-remote -h ${GIT_REPO_URL} | &quot; + 
      &quot;grep -i -P -o &apos;^[^\\s]+\\s+refs/heads/\\K(.*)\$&apos;&quot;
} 
else if (&quot;tag&quot;.equalsIgnoreCase(GIT_REF_TYPE)) {
   cmd = cmd +
      &quot;git -c core.askpass=true ls-remote -t ${GIT_REPO_URL} | &quot; + 
      &quot;grep -i -P -o &apos;^[^\\s]+\\s+refs/tags/\\K(.*)\$&apos;&quot;
}
else {
    return &quot;&lt;input type=&apos;text&apos; readonly=true name=&apos;value&apos; style=&apos;width:400px; font-family:monospace;&apos; disabled=true&gt;&quot;
}

def cmdarr = [ &quot;ssh-agent&quot;, &quot;sh&quot;, &quot;-c&quot;, cmd ]
process = new ProcessBuilder(cmdarr).start()

// Iterate over the input stream produced by having run the process (should be git ls-remote standard output)
process.inputStream.eachLine {
   if( &quot;${it}&quot;.equals(defaultValue)) {
      sb.append(&quot;&lt;option selected=true value=&apos;&quot;).append(&quot;${it}&quot;).append(&quot;&apos;&gt;&quot;).append(&quot;${it}&quot;).append(&quot;&lt;/option&gt;&quot;)
   }
   else {
      sb.append(&quot;&lt;option value=&apos;&quot;).append(&quot;${it}&quot;).append(&quot;&apos;&gt;&quot;).append(&quot;${it}&quot;).append(&quot;&lt;/option&gt;&quot;)
   }
}
process.waitForOrKill(20000);
sb.append(&quot;&lt;/select&gt;&quot;)
return sb.toString()
</script>
              <sandbox>false</sandbox>
            </secureScript>
            <secureFallbackScript plugin="script-security@1.24">
              <script>return &quot;&lt;input type=&apos;text&apos; readonly=true name=&apos;value&apos; value=&apos;error&apos; style=&apos;width:400px; font-family:monospace;&apos; disabled=true&gt;&quot;</script>
              <sandbox>false</sandbox>
            </secureFallbackScript>
          </script>
          <projectName>kuali-core-2-build-docker-image</projectName>
          <parameters class="linked-hash-map"/>
          <referencedParameters>GIT_PULL,GIT_REPO_URL,GIT_REF_TYPE</referencedParameters>
          <choiceType>ET_FORMATTED_HTML</choiceType>
          <omitValueField>false</omitValueField>
        </org.biouno.unochoice.DynamicReferenceParameter>
        <org.biouno.unochoice.DynamicReferenceParameter plugin="uno-choice@1.5.2">
          <name>GIT_COMMIT_ID</name>
          <description>This is the git commit ID that the build will be based on.
&lt;br&gt;
&lt;br&gt;</description>
          <randomName>choice-parameter-7674629744719747</randomName>
          <visibleItemCount>1</visibleItemCount>
          <script class="org.biouno.unochoice.model.GroovyScript">
            <secureScript plugin="script-security@1.24">
              <script>def commitId = null
def process = null
def cmd = &quot;ssh-add /var/lib/jenkins/.ssh/bu_github_id_core_rsa &gt; /dev/null 2&gt;&amp;1; &quot;

if(&quot;commit id&quot;.equalsIgnoreCase(GIT_REF_TYPE)) {
    return &quot;&lt;input type=&apos;text&apos; name=&apos;value&apos; style=&apos;font-family:monospace; width:400px;&apos;&gt;&quot;
}

if (&quot;branch&quot;.equalsIgnoreCase(GIT_REF_TYPE)) {
   cmd = cmd +
      &quot;git -c core.askpass=true ls-remote -h ${GIT_REPO_URL} refs/heads/ ${GIT_REF} | &quot; + 
      &quot;grep -i -P -o &apos;^[^\\s]+&apos;&quot;
}
else if (&quot;tag&quot;.equalsIgnoreCase(GIT_REF_TYPE)) {
   cmd = cmd +
      &quot;git -c core.askpass=true ls-remote -t ${GIT_REPO_URL} refs/tags/ ${GIT_REF} | &quot; + 
      &quot;grep -i -P -o &apos;^[^\\s]+&apos;&quot;
}

def cmdarr = [ &quot;ssh-agent&quot;, &quot;sh&quot;, &quot;-c&quot;, cmd ]
process = new ProcessBuilder(cmdarr).start()

// Iterate over the input stream produced by having run the process (should have only one line).
process.inputStream.eachLine {
   if(commitId == null) {
      commitId = &quot;${it}&quot;
   }
}
process.waitForOrKill(20000);


if(commitId == null) {
   return &quot;&lt;input type=&apos;text&apos; name=&apos;value&apos; disabled=true style=&apos;font-family:monospace; width:400px;&apos;&gt;&quot;
}
else {
   return &quot;&lt;input type=&apos;text&apos; name=&apos;value&apos; disabled=true value=&apos;&quot; + commitId + &quot;&apos; style=&apos;font-family:monospace; width:400px;&apos;&gt;&quot;
}</script>
              <sandbox>false</sandbox>
            </secureScript>
            <secureFallbackScript plugin="script-security@1.24">
              <script>return &quot;&lt;input type=&apos;text&apos; name=&apos;value&apos; value=&apos;error&apos; disabled=true style=&apos;font-family:monospace; width:404px;&apos;&gt;&quot;</script>
              <sandbox>false</sandbox>
            </secureFallbackScript>
          </script>
          <projectName>kuali-core-2-build-docker-image</projectName>
          <parameters class="linked-hash-map"/>
          <referencedParameters>GIT_REPO_URL,GIT_REF_TYPE,GIT_REF</referencedParameters>
          <choiceType>ET_FORMATTED_HTML</choiceType>
          <omitValueField>false</omitValueField>
        </org.biouno.unochoice.DynamicReferenceParameter>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>[ &quot;$VERBOSE&quot; == false ] &amp;&amp; set +x

ROOT_DIR=&apos;/tmp/krd/core/build.context&apos;
if [ ! -d $buildcontext ] ; then
  echo &quot;ERROR! Cannot find docker build context directory: $ROOT_DIR&quot;
  exit 1
fi

# Fix the trailing comma issue with active choices parameters reactive
GIT_PULL=&quot;$(echo $GIT_PULL | sed &apos;s/,//g&apos;)&quot;
GIT_REF=&quot;$(echo $GIT_REF | sed &apos;s/,//g&apos;)&quot;
GIT_COMMIT_ID=&quot;$(echo $GIT_COMMIT_ID | sed &apos;s/,//g&apos;)&quot;
DRYRUN=&quot;$(echo $DRYRUN | sed &apos;s/,//g&apos;)&quot;

parms=(
  &quot;interactive=false&quot;
  &quot;root_dir=$ROOT_DIR&quot;
  &quot;git_repull=$GIT_PULL&quot;
  &quot;git_branch=$GIT_REF&quot;
  &quot;git_refspec=$GIT_COMMIT_ID&quot;
  &quot;dryrun=$([ &quot;$DRYRUN&quot; == true ] &amp;&amp; echo &apos;true&apos; || echo &apos;false&apos;)&quot;
)

echo &quot;&quot;
echo &quot;================================&quot;
echo &quot;DOCKER BUILD CONTEXT:&quot;
echo &quot;================================&quot;

cd $ROOT_DIR &amp;&amp; ls -la

source $ROOT_DIR/docker.sh

build &quot;${parms[@]}&quot;

set -x</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>